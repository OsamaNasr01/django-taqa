{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %} Pump Offer Request {% endblock %}
{% block content %}

<link rel="stylesheet" href="{% static 'home/home.css' %}">

<div class="container">
    <div class="row">
        <h3>Motor Selection {{ offer.request.user.full_name }}</h3>
        <h6>{{ offer.value }}</h6>
    </div>


    <div class="products">
        <div class="header">
            <h2>Select Motor from the List</h2>
            <a href="#">See All</a>
        </div>
        <div class="content">
            {% for motor in motors %}
                <div class="images">
                    <img src="{{motor.image.url}}" alt="" />
                </div>
                <div class="text">
                    <span>{{motor.category}}</span>
                    <h4>{{motor.name}}</h4>
                    <!-- <p>{{product.description}}</p> -->
                </div>
                <div class="order">
                    <form class="form-group" id="motor_selection" method="post" action="#">
                        {% csrf_token %}
                        <input  type="hidden" value="{{offer.id}}" name="offer_id">
                        <input type="hidden" value="{{motor.id}}" name="motor_id">
                        <label for="price">Price</label>
                        <input id="price" class="form-control" type="number" value="{{motor.price}}" name="price">
                        <label for="q">Quantity</label>
                        <input id="q" class="form-control" type="number" value="1" name="q">
                        <button class="btn btn-primary form-control" id="motor_submit" type="submit">Add to offer</button>
                    </form>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="col-12">
        <form method="post" action="{% url 'pipe_selection' %}">
            {% csrf_token %}
            <input type="hidden" value="{{offer.id}}" name="offer_id">
            <button class="btn btn-primary" type="submit">Next to Pipes</button>
        </form>
    </div>

</div>


<script>
    const motor_submit = document.getElementById('motor_submit')
    motor_submit.addEventListener('click', function (e) {
        e.preventDefault()
        const motor_selection = document.getElementById('motor_selection')
        const data_form = new FormData(motor_selection)
        console.log(data_form.get('price'))
        if (motor_submit.innerText === 'Remove from offer') {
            url = '/pump-offer/remove-motor-from-offer/'
        } else {
            url = '/pump-offer/add-motor-to-offer/'
        }
        fetch(url, {
            'method' : 'POST',
            'body': data_form,
        }) 
        .then(response => {
            if (response.ok) {
              console.log(response)
              return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
          console.log(data)
          if (data['data'] === 'added') {
            motor_submit.className = "btn btn-danger form-control"
            motor_submit.innerText = 'Remove from offer'

          } else {
            motor_submit.className = "btn btn-primary form-control"
            motor_submit.innerText = 'Add to offer'

          }
        })
        .catch((error) => {
            console.log(error)
        })
    

    })
</script>
{% endblock %}
