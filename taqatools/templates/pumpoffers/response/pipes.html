{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %} Pump Offer Request {% endblock %}
{% block content %}

<link rel="stylesheet" href="{% static 'home/home.css' %}">

<div class="container">
    <div class="row">
        <h3>Pipes Selection {{ offer.request.user.full_name }}</h3>
        <h6>{{ offer.value }}</h6>
    </div>


    <div class="products">
        <div class="header">
            <h2>Select Pipes from the List</h2>
            <a href="#">See All</a>
        </div>
        <div class="content">
            {% for pipe in pipes %}
                <div class="images">
                    <img src="{{pipe.image.url}}" alt="" />
                </div>
                <div class="text">
                    <span>{{pipe.category}}</span>
                    <h4>{{pipe.name}}</h4>
                    <!-- <p>{{product.description}}</p> -->
                </div>
                <div class="order">
                    <form class="form-group" id="pipe_selection" method="post" action="#">
                        {% csrf_token %}
                        <input  type="hidden" value="{{offer.id}}" name="offer_id">
                        <input type="hidden" value="{{pipe.id}}" name="pipe_id">
                        <label for="price">Price</label>
                        <input id="price" class="form-control" type="number" value="{{pipe.price}}" name="price">
                        <label for="q">Quantity</label>
                        <input id="q" class="form-control" type="number" value="1" name="q">
                        <button class="btn btn-primary form-control" id="pipe_submit" type="submit">Add to offer</button>
                    </form>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="col-12">
        <form method="post" action="{% url 'adaptors_selection' %}">
            {% csrf_token %}
            <input type="hidden" value="{{offer.id}}" name="offer_id">
            <button class="btn btn-primary" type="submit">Next to Adaptors</button>
        </form>
    </div>

</div>


<script>
    const pipe_submit = document.getElementById('pipe_submit')
    pipe_submit.addEventListener('click', function (e) {
        e.preventDefault()
        const pipe_selection = document.getElementById('pipe_selection')
        const data_form = new FormData(pipe_selection)
        console.log(data_form.get('price'))
        if (pipe_submit.innerText === 'Remove from offer') {
            url = '/pump-offer/remove-pipe-from-offer/'
        } else {
            url = '/pump-offer/add-pipe-to-offer/'
        }
        fetch(url, {
            'method' : 'POST',
            'body': data_form,
        }) 
        .then(response => {
            if (response.ok) {
              console.log(response)
              return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
          console.log(data)
          if (data['data'] === 'added') {
            pipe_submit.className = "btn btn-danger form-control"
            pipe_submit.innerText = 'Remove from offer'

          } else {
            pipe_submit.className = "btn btn-primary form-control"
            pipe_submit.innerText = 'Add to offer'

          }
        })
        .catch((error) => {
            console.log(error)
        })
    

    })
</script>
{% endblock %}
