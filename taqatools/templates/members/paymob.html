{% extends 'base.html' %}
{% load static %}
{% block title %}عرض سعر طلمبة غاطسة {% endblock %}

{% load humanize %}



{% block content %}

<div class="container">
    <div class="row">
        <div class="col-6">
            <button id="card_btn" class="btn btn-primary form-control">الدفع من خلال كارت</button>
         </div>
        <div class="col-6">            
            <button onclick="wallet_pay_click()" class="btn btn-primary form-control">الدفع من خلال محفظة اليكترونية</button>
        </div>
    </div>
    <br>
    <div id="wallet" hidden class="row">
        <div class="col-12 form-group">
            <form class="form-group" action="">
            <label for="phone">ادخل رقم المحفظة الالكترونية</label>
            <input id="phone" class="form-control" type="number"><br>
            <button class="form-control btn btn-primary">تأكيد الرقم</button>
            </form>
        </div>
    </div>

</div>
<script>
    function card_pay_request(payment_token)  {
                
        url = `https://accept.paymob.com/api/acceptance/iframes/740313?payment_token=${payment_token}`
        window.location.href = url


    }

    function wallet_pay_request(payment_token)  {
        let data = {
            "source": {
              "identifier": "01557444030", 
              "subtype": "WALLET"
            },
            "payment_token": payment_token,
          }
                
        url = 'https://accept.paymob.com/api/acceptance/payments/pay'
        fetch(url, {
            'method' : 'POST',
            'headers' : {
                'Content-Type': 'application/json',
            },
            'body': JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log(response)
                return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
            console.log(data)
            window.location.href = data.iframe_redirection_url

        })
        .catch((error) => {
            console.log(error)
        })

    }

    function request_payment_key(token, id, int_id, gate) {
        let data = {
            "auth_token": token,
            "amount_cents": "1000", 
            "expiration": 3600, 
            "order_id": id,
            "billing_data": {
              "apartment": "NA", 
              "email": "osama.nasr.01@gmail.com", 
              "floor": "NA", 
              "first_name": "Osama", 
              "street": "NA", 
              "building": "NA", 
              "phone_number": "01027476938", 
              "shipping_method": "NA", 
              "postal_code": "NA", 
              "city": "NA", 
              "country": "Eg", 
              "last_name": "Nasr", 
              "state": "NA"
            }, 
            "currency": "EGP", 
            "integration_id": int_id,
          }
                
        url = 'https://accept.paymob.com/api/acceptance/payment_keys'
        fetch(url, {
            'method' : 'POST',
            'headers' : {
                'Content-Type': 'application/json',
            },
            'body': JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log(response)
                return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
            console.log(data.token) 
            if (gate===wallet){
                wallet_pay_request(data.token)
            } else {
                card_pay_request(data.token)
            }
            
        })
        .catch((error) => {
            console.log(error)
        })

    }

    function make_order(token) {
        let data = {
            "auth_token":  token,
            "delivery_needed": "false",
            "amount_cents": "1000",
            "currency": "EGP",
            "items": [],
          }
                
        url = 'https://accept.paymob.com/api/ecommerce/orders'
        fetch(url, {
            'method' : 'POST',
            'headers' : {
                'Content-Type': 'application/json',
            },
            'body': JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log(response)
                return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
            console.log(data.id)
            const card_btn = document.getElementById('card_btn')
            card_btn.setAttribute('onclick', `card_pay_click('${token}', '${data.id}', '3544186', 'card')`)
        })
        .catch((error) => {
            console.log(error)
        })

    }

    const api_key = 'ZXlKMGVYQWlPaUpLVjFRaUxDSmhiR2NpT2lKSVV6VXhNaUo5LmV5SndjbTltYVd4bFgzQnJJam8zTVRZd016a3NJbU5zWVhOeklqb2lUV1Z5WTJoaGJuUWlMQ0p1WVcxbElqb2lhVzVwZEdsaGJDSjkuUHVXVVh1NUlUdDQ2NjdFVmV1YUdzVkZwb0JmQm56N0NFRmtiLVMzNFNmazRnQkhQX3Fxb24yU0R4RkRzeklISDM5c3FJSWE4MUVqcm50LWNvd3k4WUE='
    function get_token() {
        let data = {
            'api_key':api_key,
        }
                
        url = ' https://accept.paymob.com/api/auth/tokens'
        fetch(url, {
            'method' : 'POST',
            'headers' : {
                'Content-Type': 'application/json',
            },
            'body': JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log(response)
                return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
            console.log(data.token)
            make_order(data.token)
        })
        .catch((error) => {
            console.log(error)
        })
    }

    get_token()

    function card_pay_click(token, id, int_id, gate) {
        request_payment_key(token, id, int_id, gate)
    }

    function get_wallet_no(token, id, int_id, gate) {
        const wallet_no = document.getElementById('phone').value
        request_payment_key(token, id, int_id, gate)
    }

    function wallet_pay_click() {
        const wallet_form = document.getElementById('wallet')
        wallet_form.removeAttribute('hidden')
    }


</script>

{% endblock %}

