{% extends 'base.html' %}
{% load static %}
{% block title %}عرض سعر طلمبة غاطسة {% endblock %}

{% load humanize %}



{% block content %}

<div class="container">

</div>
<script>
    function card_pay_request(payment_token)  {
                
        url = `https://accept.paymob.com/api/acceptance/iframes/740313?payment_token=${payment_token}`
        window.location.href = url


    }

    function wallet_pay_request(payment_token)  {
        let data = {
            "source": {
              "identifier": "01027476938", 
              "subtype": "WALLET"
            },
            "payment_token": payment_token,
          }
                
        url = 'https://accept.paymob.com/api/acceptance/payments/pay'
        fetch(url, {
            'method' : 'POST',
            'headers' : {
                'Content-Type': 'application/json',
            },
            'body': JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log(response)
                return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
            console.log(data)
            window.location.href = data.iframe_redirection_url

        })
        .catch((error) => {
            console.log(error)
        })

    }

    function request_payment_key(token, id) {
        let data = {
            "auth_token": token,
            "amount_cents": "1000", 
            "expiration": 3600, 
            "order_id": id,
            "billing_data": {
              "apartment": "NA", 
              "email": "osama.nasr.01@gmail.com", 
              "floor": "NA", 
              "first_name": "Osama", 
              "street": "NA", 
              "building": "NA", 
              "phone_number": "01027476938", 
              "shipping_method": "NA", 
              "postal_code": "NA", 
              "city": "NA", 
              "country": "Eg", 
              "last_name": "Nasr", 
              "state": "NA"
            }, 
            "currency": "EGP", 
            "integration_id": 3765052,
          }
                
        url = 'https://accept.paymob.com/api/acceptance/payment_keys'
        fetch(url, {
            'method' : 'POST',
            'headers' : {
                'Content-Type': 'application/json',
            },
            'body': JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log(response)
                return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
            console.log(data.token) 
            card_pay_request(data.token)
        })
        .catch((error) => {
            console.log(error)
        })

    }

    function make_order(token) {
        let data = {
            "auth_token":  token,
            "delivery_needed": "false",
            "amount_cents": "1000",
            "currency": "EGP",
            "items": [],
          }
                
        url = 'https://accept.paymob.com/api/ecommerce/orders'
        fetch(url, {
            'method' : 'POST',
            'headers' : {
                'Content-Type': 'application/json',
            },
            'body': JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log(response)
                return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
            console.log(data.id)
            request_payment_key(token, data.id)
        })
        .catch((error) => {
            console.log(error)
        })

    }

    const api_key = 'ZXlKMGVYQWlPaUpLVjFRaUxDSmhiR2NpT2lKSVV6VXhNaUo5LmV5SndjbTltYVd4bFgzQnJJam8zTVRZd016a3NJbU5zWVhOeklqb2lUV1Z5WTJoaGJuUWlMQ0p1WVcxbElqb2lhVzVwZEdsaGJDSjkuUHVXVVh1NUlUdDQ2NjdFVmV1YUdzVkZwb0JmQm56N0NFRmtiLVMzNFNmazRnQkhQX3Fxb24yU0R4RkRzeklISDM5c3FJSWE4MUVqcm50LWNvd3k4WUE='
    function get_token() {
        let data = {
            'api_key':api_key,
        }
                
        url = ' https://accept.paymob.com/api/auth/tokens'
        fetch(url, {
            'method' : 'POST',
            'headers' : {
                'Content-Type': 'application/json',
            },
            'body': JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log(response)
                return response.json()
            } else {
            console.log(response)
            }
        })
        .then(data => {
            console.log(data.token)
            make_order(data.token)
        })
        .catch((error) => {
            console.log(error)
        })
    }

    get_token()



</script>

{% endblock %}

